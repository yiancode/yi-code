---
stepsCompleted: [1, 2, 3, 4]
inputDocuments:
  - docs/余额充值功能设计方案.md
  - docs/IMPLEMENTATION_PLAN.md
  - docs/微信支付Go-SDK集成指南.md
  - _bmad-output/planning-artifacts/ux-design.md
---

# yi-code - 余额充值功能 Epic Breakdown

## Overview

This document provides the complete epic and story breakdown for yi-code 余额充值功能, decomposing the requirements from the design documents into implementable stories.

---

## 业务流程图

### 用户充值流程时序图

```
用户                 前端                 后端                 微信支付
 |                    |                    |                       |
 | 1. 进入充值页面     |                    |                       |
 |-------------------->|                    |                       |
 |                    | 2. 获取配置          |                       |
 |                    |-------------------->|                       |
 |                    |<--------------------| (充值金额档位、限额)    |
 |                    |                    |                       |
 | 3. 输入金额 + 下单   |                    |                       |
 |-------------------->|                    |                       |
 |                    | 4. 创建订单          |                       |
 |                    |-------------------->|                       |
 |                    |                    | 5. 调用下单API         |
 |                    |                    |---------------------->|
 |                    |                    |<----------------------| (prepay_id/code_url)
 |                    |<--------------------| (订单号 + 支付参数)     |
 |                    |                    |                       |
 | 6. 展示支付界面     |                    |                       |
 |  (二维码/调起微信)   |                    |                       |
 |<--------------------|                    |                       |
 |                    |                    |                       |
 | 7. 用户完成支付     |                    |                       |
 |----------------------------------------------------->|
 |                    |                    |                       |
 |                    |                    | 8. 微信回调             |
 |                    |                    |<----------------------|
 |                    |                    | 9. 验签 + 幂等性检查     |
 |                    |                    | 10. 更新订单状态        |
 |                    |                    | 11. 增加用户余额        |
 |                    |                    | 12. 记录余额日志        |
 |                    |                    |---------------------->| (返回SUCCESS)
 |                    |                    |                       |
 | 13. 前端轮询订单状态 |                    |                       |
 |                    |-------------------->|                       |
 |                    |<--------------------| (订单已支付)           |
 |                    |                    |                       |
 | 14. 跳转充值成功页面 |                    |                       |
 |<--------------------|                    |                       |
```

### 订单状态机

```
                          ┌─────────────┐
                          │   pending   │ (待支付)
                          └──────┬──────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │                      │                      │
          ▼                      ▼                      ▼
   ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
   │   expired   │       │    paid     │       │   failed    │
   │  (已过期)    │       │   (已支付)   │       │   (失败)    │
   └─────────────┘       └──────┬──────┘       └─────────────┘
                                │
                                ▼
                         ┌─────────────┐
                         │  refunded   │
                         │  (已退款)    │
                         └─────────────┘

状态转换规则:
- pending → paid: 微信支付回调成功
- pending → expired: 超过过期时间(120分钟)未支付
- pending → failed: 用户取消或支付失败
- paid → refunded: 管理员触发退款
```

### 支付回调处理流程

```
                    微信支付回调请求
                          │
                          ▼
                   ┌─────────────┐
                   │ 记录回调日志 │
                   └──────┬──────┘
                          │
                          ▼
                   ┌─────────────┐
               NO  │  签名验证？  │
              ┌────┤             ├────┐
              │    └─────────────┘    │ YES
              ▼                       ▼
      ┌─────────────┐         ┌─────────────┐
      │ 返回 FAIL    │         │ 解密回调数据 │
      │ 记录失败日志 │         └──────┬──────┘
      └─────────────┘                │
                                     ▼
                              ┌─────────────┐
                          NO  │ Redis分布锁? │
                         ┌────┤             ├────┐
                         │    └─────────────┘    │ YES
                         ▼                       ▼
                 ┌─────────────┐         ┌─────────────┐
                 │ 返回 SUCCESS │         │ 开启DB事务  │
                 │ (已处理过)   │         └──────┬──────┘
                 └─────────────┘                │
                                               ▼
                                        ┌─────────────┐
                                    NO  │订单状态=    │
                                   ┌────┤ pending?   ├────┐
                                   │    └─────────────┘    │ YES
                                   ▼                       ▼
                           ┌─────────────┐         ┌─────────────┐
                           │ 返回 SUCCESS │         │ 金额校验    │
                           │ (状态已变更) │         └──────┬──────┘
                           └─────────────┘                │
                                                          ▼
                                                   ┌─────────────┐
                                               NO  │ 金额匹配?   │
                                              ┌────┤             ├────┐
                                              │    └─────────────┘    │ YES
                                              ▼                       ▼
                                      ┌─────────────┐         ┌─────────────┐
                                      │ 返回 FAIL    │         │ 更新订单状态 │
                                      │ 金额不匹配   │         │ 为 paid      │
                                      └─────────────┘         └──────┬──────┘
                                                                     │
                                                                     ▼
                                                              ┌─────────────┐
                                                              │ 增加用户余额 │
                                                              │ (行锁保护)  │
                                                              └──────┬──────┘
                                                                     │
                                                                     ▼
                                                              ┌─────────────┐
                                                              │ 记录余额日志 │
                                                              └──────┬──────┘
                                                                     │
                                                                     ▼
                                                              ┌─────────────┐
                                                              │ 提交事务    │
                                                              │ 返回SUCCESS │
                                                              └──────┬──────┘
                                                                     │
                                                                     ▼
                                                              ┌─────────────┐
                                                              │ 异步发送通知│
                                                              │ (站内信)   │
                                                              └─────────────┘
```

### 前端页面路由图

```
                          ┌─────────────────┐
                          │ 用户主页/菜单    │
                          │ (显示余额充值入口)│
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │  /recharge      │
                          │  充值主页       │
                          │  (选择金额)     │
                          └────────┬────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
     ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
     │ /recharge/paying│  │ /recharge/      │  │ 查看充值记录    │
     │ 支付中页面      │  │ records         │  │ (导航链接)      │
     │ (二维码/等待)   │  │ 充值记录列表    │  └─────────────────┘
     └────────┬────────┘  └─────────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
    ▼                   ▼
┌─────────────┐   ┌─────────────┐
│ /recharge/  │   │ /recharge/  │
│ success     │   │ failed      │
│ 充值成功    │   │ 充值失败    │
└─────────────┘   └─────────────┘
```

---

## Requirements Inventory

### Functional Requirements

#### 配置管理类（敏感 vs 非敏感分离）

**FR1**: 系统启动时从配置文件（`config.yaml`）加载微信支付敏感配置（不暴露到管理端）：
- `wechat_pay.enabled` - 是否启用微信支付
- `wechat_pay.app_id` - 微信应用ID
- `wechat_pay.mch_id` - 商户号
- `wechat_pay.api_v3_key` - APIv3密钥
- `wechat_pay.cert_serial_no` - 证书序列号
- `wechat_pay.private_key_path` - 商户私钥文件路径
- `wechat_pay.notify_url` - 支付回调地址

**FR2**: 管理员可以在系统设置页面查看充值功能状态（只读显示）：
- 是否启用微信支付（enabled: true/false）
- 当前使用的AppID（脱敏显示，如：wx0b35f0****fb07e）
- 回调地址（只读显示）

**FR3**: 管理员可以在系统设置页面调整充值业务配置（非敏感配置）：
- 最小充值金额（`recharge.min_amount`）
- 最大充值金额（`recharge.max_amount`）
- 默认充值金额选项（`recharge.default_amounts`）
- 订单过期时间（`recharge.order_expire_minutes`）

**FR4**: 管理端充值配置修改后，系统将配置保存到数据库（`settings` 表），并实时生效（无需重启服务）

**FR5**: 系统优先使用数据库中的充值业务配置，如果数据库中不存在则使用 `config.yaml` 的默认值

#### 用户充值流程类

**FR6**: 用户可以进入充值页面，查看当前账户余额

**FR7**: 用户可以选择充值金额（快捷金额按钮或自定义输入）

**FR8**: 系统验证充值金额在允许范围内（`min_amount` ~ `max_amount`）

**FR9**: 用户可以选择支付方式（微信支付），并发起充值订单

**FR10**: 系统创建充值订单，生成唯一订单号（格式：RECH+年月日时分秒+10位随机字符串）

**FR11**: 系统调用微信支付API创建支付订单（支持JSAPI和Native两种支付渠道）

**FR12**: Native支付渠道返回二维码URL，前端展示二维码供用户扫码支付

**FR13**: JSAPI支付渠道返回前端调起参数，用户在微信内完成支付

#### 支付回调处理类

**FR14**: 用户支付成功后，微信支付平台异步推送回调通知到系统

**FR15**: 系统接收并验证微信支付回调（签名验证、数据解密）

**FR16**: 回调验证通过后，系统更新订单状态为"已支付"（paid）

**FR17**: 系统在数据库事务中增加用户余额，保证原子性

**FR18**: 系统插入余额变动日志（balance_logs），记录变动前后余额

**FR19**: 系统异步发送充值成功通知（站内信）

#### 订单管理类

**FR20**: 用户可以查询单个充值订单的详细状态

**FR21**: 用户可以查看充值记录列表（分页展示，每页10条）

**FR22**: 用户可以取消未支付的订单（状态从pending变为failed）

**FR23**: 系统自动将超过过期时间的pending订单标记为expired

**FR24**: 系统定时任务每分钟执行一次订单过期检查

**FR25**: 订单过期时调用微信"关闭订单"API，防止用户在过期后仍能支付成功

#### 补偿机制类

**FR26**: 用户可以点击"手动查询订单状态"按钮，主动触发订单状态同步

**FR27**: 系统调用微信支付查询接口，获取订单的真实支付状态

**FR28**: 如果微信返回支付成功但本地状态为pending，系统自动触发余额到账逻辑

**FR29**: 定时任务每5分钟扫描pending状态且创建时间>5分钟的订单，主动调用微信查询接口

#### 前端展示类

**FR30**: 系统根据 `wechat_pay.enabled` 和 `recharge.enabled` 配置自动控制充值菜单的显示/隐藏

**FR31**: 前端轮询查询订单状态（每3秒一次，最多40次/2分钟），支付成功后自动跳转

**FR32**: 支付中页面展示订单过期倒计时

**FR33**: 充值成功后显示成功页面，展示充值金额、订单号和当前余额

**FR34**: 充值失败或过期后显示失败页面，展示失败原因和重新充值按钮

#### 风控类

**FR35**: 同一用户1分钟内最多创建3个订单（分钟级限流）

**FR36**: 同一用户每天最多创建20个订单（日级限流）

**FR37**: 同一IP短时间内创建大量订单时触发验证码验证

#### 退款类（预留）

**FR38**: 管理员可以在后台对已支付订单触发退款操作

**FR39**: 系统调用微信退款API并扣减用户余额

**FR40**: 更新订单状态为refunded，记录退款日志

---

### NonFunctional Requirements

#### 安全性

**NFR1**: 微信支付APIv3密钥和商户私钥必须安全存储，不暴露到前端

**NFR2**: 所有微信支付回调必须进行签名验证，拒绝无效签名的请求

**NFR3**: 支持IP白名单验证，只允许微信支付回调IP段（120.232.x.x等）访问回调接口

**NFR4**: 回调时验证订单金额=回调金额，防止金额篡改攻击

**NFR5**: 回调时验证用户ID匹配，防止订单劫持

**NFR6**: 检查微信支付回调请求时间戳，拒绝超过5分钟的请求（防重放攻击）

#### 幂等性

**NFR7**: 使用Redis分布式锁确保同一订单的回调只处理一次

**NFR8**: 使用数据库行锁（SELECT FOR UPDATE）确保余额更新的并发安全

**NFR9**: 订单状态检查：只处理状态为pending的订单

**NFR10**: 使用payment_callbacks表记录所有回调，快速判断是否重复

#### 性能

**NFR11**: 充值订单创建接口限流：同一用户1分钟最多创建3个订单

**NFR12**: 微信支付API调用超时设置为30秒

**NFR13**: 支付回调处理时间应在5秒内完成

**NFR14**: 充值页面响应时间 < 2秒

**NFR15**: 二维码生成时间 < 1秒

#### 可靠性

**NFR16**: 订单数据和余额变动必须在同一数据库事务中完成，确保数据一致性

**NFR17**: 微信支付回调失败时，微信会自动重试（最多通知3次）

**NFR18**: 系统启动时自动加载微信支付配置，配置错误时记录日志但不影响其他功能

#### 可维护性

**NFR19**: 所有支付相关操作必须记录详细日志（订单创建、回调处理、余额变动）

**NFR20**: 记录所有支付回调到payment_callbacks表，保留原始请求数据用于调试

#### 可扩展性

**NFR21**: 支付服务层使用接口抽象（PaymentProvider），支持未来接入其他支付方式（支付宝、Stripe等）

#### 合规性

**NFR22**: 符合微信支付API v3标准和安全规范

#### 数据完整性

**NFR23**: 所有余额变动必须记录before/after余额，支持审计追溯

**NFR24**: 余额日志表（balance_logs）只允许插入，不允许修改删除

#### 可观测性

**NFR25**: 异常监控告警（短时间内大量订单未支付、连续小额充值等）

---

### Additional Requirements

#### 架构需求

- 使用官方微信支付Go SDK (`github.com/wechatpay-apiv3/wechatpay-go`)
- 采用分层架构：Handler → Service → Repository
- 使用Ent ORM进行数据库操作
- 使用Wire进行依赖注入
- 使用PostgreSQL存储订单和余额数据
- 使用Redis实现分布式锁和缓存

#### 数据库需求

**新增3张表**（用户表已有 balance 字段，无需修改）：

1. **recharge_orders（充值订单表）**
   - order_no: 订单号（唯一索引）
   - user_id: 用户ID（索引）
   - amount: 充值金额
   - actual_amount: 实际到账金额
   - status: 订单状态（pending/paid/failed/expired/refunded）
   - payment_method: 支付方式
   - payment_channel: 支付渠道
   - transaction_id: 微信支付订单号
   - prepay_id: 预支付ID
   - code_url: Native支付二维码URL
   - paid_at: 支付时间
   - expired_at: 过期时间
   - notify_result: 回调原始数据（JSON）

2. **balance_logs（余额日志表）**
   - user_id: 用户ID（索引）
   - change_type: 变动类型（recharge/consume/refund/adjust）
   - amount: 变动金额
   - balance_before: 变动前余额
   - balance_after: 变动后余额
   - related_order_no: 关联订单号
   - description: 变动描述
   - operator_id: 操作人ID
   - operator_type: 操作人类型（system/admin/user）

3. **payment_callbacks（回调日志表）**
   - order_no: 订单号（索引）
   - payment_method: 支付方式
   - transaction_id: 支付平台订单号
   - request_headers: 请求头（JSON）
   - request_body: 请求体（JSON）
   - signature_valid: 签名验证结果
   - process_status: 处理状态
   - process_message: 处理结果描述

**注意**: 非敏感业务配置（充值金额选项、限额等）存储在现有 `settings` 表（key-value 模式），无需新建 payment_configs 表。

#### API接口需求

| 接口 | 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|------|
| 获取充值配置 | GET | /api/v1/recharge/config | JWT | 返回充值金额选项、限额等 |
| 创建充值订单 | POST | /api/v1/recharge/orders | JWT+限流 | 创建订单并返回支付参数 |
| 查询订单状态 | GET | /api/v1/recharge/orders/:order_no | JWT | 查询单个订单详情 |
| 充值记录列表 | GET | /api/v1/recharge/orders | JWT | 分页查询用户充值记录 |
| 取消订单 | POST | /api/v1/recharge/orders/:order_no/cancel | JWT | 取消未支付订单 |
| 手动同步订单 | POST | /api/v1/recharge/orders/:order_no/sync | JWT | 主动查询微信支付状态 |
| 微信支付回调 | POST | /api/v1/webhook/wechat/payment | 签名+IP白名单 | 接收微信异步通知 |

#### 前端需求

**新增页面（5个，位于 `src/views/user/recharge/`）：**
- `RechargeView.vue` - 充值首页（选择金额）
- `RechargePayingView.vue` - 支付中页面（二维码/等待）
- `RechargeSuccessView.vue` - 充值成功页面
- `RechargeFailedView.vue` - 充值失败页面
- `RechargeRecordsView.vue` - 充值记录页面

**新增组件（5个，位于 `src/components/user/recharge/`）：**
- `AmountSelector.vue` - 金额选择器
- `PaymentMethodSelector.vue` - 支付方式选择器
- `QRCodeDisplay.vue` - 二维码展示
- `OrderCountdown.vue` - 订单倒计时
- `RechargeRecordItem.vue` - 充值记录项

**新增Store（1个，位于 `src/stores/`）：**
- `recharge.ts` - 充值状态管理（Pinia）

**新增API客户端（1个，位于 `src/api/`）：**
- `recharge.ts` - 充值API客户端

#### 中间件需求

- 幂等性中间件（基于Redis分布式锁）
- IP白名单中间件（验证微信支付回调IP）
- 限流中间件（充值接口，1分钟3次）

#### 定时任务需求

| 任务名称 | 执行频率 | 说明 |
|---------|---------|------|
| 订单过期检查 | 每分钟 | 将超时pending订单标记为expired，调用微信关闭订单API |
| 订单状态补偿 | 每5分钟 | 扫描pending状态且创建时间>5分钟的订单，主动查询微信状态 |

#### 配置管理需求

- 生产环境配置路径：`/www/wwwroot/code.ai80.vip/backend/config.yaml`
- 证书文件路径：`/www/wwwroot/code.ai80.vip/backend/certs/apiclient_key.pem`
- 证书文件权限：600（只读）
- 支持环境变量覆盖敏感配置

---

### FR Coverage Map

| FR | Epic | 简述 |
|----|------|------|
| FR1 | Epic 1 | 从config.yaml加载微信支付敏感配置 |
| FR2 | Epic 1 | 管理端只读显示支付状态（脱敏） |
| FR3 | Epic 1 | 管理端调整非敏感业务配置 |
| FR4 | Epic 1 | 配置保存到数据库，实时生效 |
| FR5 | Epic 1 | 配置优先级：数据库 > config.yaml |
| FR6 | Epic 2 | 进入充值页面，查看当前余额 |
| FR7 | Epic 2 | 选择充值金额（快捷按钮/自定义） |
| FR8 | Epic 2 | 验证充值金额在允许范围内 |
| FR9 | Epic 2 | 选择支付方式并发起订单 |
| FR10 | Epic 2 | 创建唯一订单号 |
| FR11 | Epic 2 | 调用微信支付API创建支付订单 |
| FR12 | Epic 2 | Native支付返回二维码URL |
| FR13 | Epic 2 | JSAPI支付返回调起参数 |
| FR14 | Epic 3 | 接收微信支付异步回调 |
| FR15 | Epic 3 | 验证回调签名和解密数据 |
| FR16 | Epic 3 | 更新订单状态为已支付 |
| FR17 | Epic 3 | 事务中增加用户余额 |
| FR18 | Epic 3 | 插入余额变动日志 |
| FR19 | Epic 3 | 异步发送充值成功通知 |
| FR20 | Epic 4 | 查询单个订单详细状态 |
| FR21 | Epic 4 | 查看充值记录列表（分页） |
| FR22 | Epic 4 | 取消未支付订单 |
| FR23 | Epic 4 | 自动标记过期订单 |
| FR24 | Epic 4 | 定时任务每分钟检查过期 |
| FR25 | Epic 4 | 过期时调用微信关闭订单API |
| FR26 | Epic 5 | 手动触发订单状态同步按钮 |
| FR27 | Epic 5 | 调用微信支付查询接口 |
| FR28 | Epic 5 | 微信已支付但本地pending时自动到账 |
| FR29 | Epic 5 | 定时任务每5分钟扫描并主动查询 |
| FR30 | Epic 1 | 根据配置控制充值菜单显隐 |
| FR31 | Epic 4 | 前端轮询订单状态 |
| FR32 | Epic 4 | 支付中页面展示倒计时 |
| FR33 | Epic 4 | 充值成功页面 |
| FR34 | Epic 4 | 充值失败页面 |
| FR35 | Epic 6 | 同一用户1分钟最多3个订单 |
| FR36 | Epic 6 | 同一用户每天最多20个订单 |
| FR37 | Epic 6 | 同一IP大量订单触发验证码 |
| FR38 | Epic 7 | 管理员触发退款操作 |
| FR39 | Epic 7 | 调用微信退款API并扣减余额 |
| FR40 | Epic 7 | 更新订单状态为已退款 |

---

## Epic List

### Epic 1: 微信支付集成与配置管理
**用户成果**: 系统管理员可以配置微信支付并管理充值业务参数，用户可以在系统中看到充值入口

**FRs覆盖:** FR1, FR2, FR3, FR4, FR5, FR30

**实现要点:**
- 后端从 `config.yaml` 加载微信支付敏感配置（app_id, mch_id, api_v3_key等）
- 管理端只读显示支付状态（脱敏处理）
- 管理端可调整非敏感业务配置（充值金额选项、限额等）
- 配置保存到数据库 `settings` 表，支持实时生效
- 前端根据配置控制充值菜单显示/隐藏

---

### Epic 2: 充值订单创建与支付
**用户成果**: 用户可以选择充值金额，创建订单并通过微信完成支付

**FRs覆盖:** FR6, FR7, FR8, FR9, FR10, FR11, FR12, FR13

**实现要点:**
- 充值首页展示当前余额和金额选择器
- 支持快捷金额按钮和自定义输入
- 金额范围验证（min_amount ~ max_amount）
- 创建订单生成唯一订单号（RECH+时间戳+随机串）
- 调用微信支付API，支持Native和JSAPI两种渠道
- Native返回二维码URL，JSAPI返回前端调起参数

---

### Epic 3: 支付回调与余额到账
**用户成果**: 用户支付成功后，余额自动到账并收到通知

**FRs覆盖:** FR14, FR15, FR16, FR17, FR18, FR19

**实现要点:**
- 接收微信支付异步回调通知
- 签名验证 + 数据解密
- Redis分布式锁保证幂等性
- 数据库事务：更新订单状态 + 增加用户余额 + 记录余额日志
- 异步发送站内信通知

---

### Epic 4: 订单状态管理与前端体验
**用户成果**: 用户可以查看订单状态、充值记录，系统自动处理过期订单

**FRs覆盖:** FR20, FR21, FR22, FR23, FR24, FR25, FR31, FR32, FR33, FR34

**实现要点:**
- 订单详情查询API
- 充值记录列表（分页，每页10条）
- 用户可取消未支付订单
- 定时任务每分钟检查过期订单
- 过期时调用微信"关闭订单"API
- 前端轮询订单状态（3秒/次，最多40次）
- 支付中页面展示倒计时
- 成功/失败页面

---

### Epic 5: 支付状态补偿机制
**用户成果**: 回调延迟时用户可手动查询订单状态，系统自动补偿未正确到账的订单

**FRs覆盖:** FR26, FR27, FR28, FR29

**实现要点:**
- 手动同步订单状态按钮
- 调用微信支付查询接口
- 微信已支付但本地pending时触发到账逻辑
- 定时任务每5分钟扫描并主动查询

---

### Epic 6: 风控与安全防护
**用户成果**: 系统防止恶意刷单和滥用行为，保障支付安全

**FRs覆盖:** FR35, FR36, FR37

**实现要点:**
- 用户级限流：1分钟3个订单，每天20个订单
- IP级限流：大量订单触发验证码
- 基于Redis的限流中间件

---

### Epic 7: 退款管理（预留）
**用户成果**: 管理员可以为已支付订单处理退款，用户余额相应扣减

**FRs覆盖:** FR38, FR39, FR40

**实现要点:**
- 管理端退款操作入口
- 调用微信退款API
- 扣减用户余额
- 更新订单状态为refunded
- 记录退款日志

---

## Epic 依赖关系图

```
Epic 1 (配置管理)
    │
    ├──> Epic 2 (订单创建) ──> Epic 3 (回调到账) ──> Epic 4 (订单管理)
    │                                                    │
    │                                                    └──> Epic 5 (补偿机制)
    │
    └──> Epic 6 (风控) [可并行]

Epic 7 (退款) [独立，可在任意时间点实施]
```

**建议实施顺序:** Epic 1 → Epic 2 → Epic 3 → Epic 4 → Epic 5 → Epic 6 → Epic 7

---

## User Stories

### Epic 1: 微信支付集成与配置管理

#### Story 1.1: 加载微信支付敏感配置
**作为** 系统运维人员
**我希望** 系统启动时自动从config.yaml加载微信支付敏感配置
**以便** 安全地管理支付凭证，不暴露到前端或管理界面

**验收标准:**
- [ ] 系统启动时从 `config.yaml` 读取 `wechat_pay` 配置节
- [ ] 加载以下敏感配置项：`enabled`, `app_id`, `mch_id`, `api_v3_key`, `cert_serial_no`, `private_key_path`, `notify_url`
- [ ] 配置加载失败时记录错误日志，但不影响系统其他功能启动
- [ ] 私钥文件路径验证：文件存在且权限正确（600）
- [ ] 使用官方微信支付Go SDK初始化客户端

**技术要点:**
- 在 `backend/internal/config/config.go` 中新增 WeChatPayConfig 结构：
  ```go
  type WeChatPayConfig struct {
      Enabled        bool   `mapstructure:"enabled"`
      AppID          string `mapstructure:"app_id"`
      MchID          string `mapstructure:"mch_id"`
      APIv3Key       string `mapstructure:"api_v3_key"`
      CertSerialNo   string `mapstructure:"cert_serial_no"`
      PrivateKeyPath string `mapstructure:"private_key_path"`
      NotifyURL      string `mapstructure:"notify_url"`
  }
  ```
- 在 Config 结构中添加 `WeChatPay WeChatPayConfig`
- 使用 Wire 进行依赖注入
- 配置加载时校验必填字段（当 enabled=true 时）

**覆盖需求:** FR1

---

#### Story 1.2: 管理端只读显示支付状态
**作为** 系统管理员
**我希望** 在管理后台查看微信支付配置状态（脱敏显示）
**以便** 了解支付功能是否正常配置，无需访问服务器

**验收标准:**
- [ ] 管理端「系统设置」页面新增「支付配置」卡片
- [ ] 显示微信支付启用状态（已启用/未启用）
- [ ] 显示脱敏AppID（如：wx0b35f0****fb07e）
- [ ] 显示回调地址（只读）
- [ ] 所有敏感字段不可编辑
- [ ] 配置未启用时显示「未配置」状态

**技术要点:**
- 新增 GET `/api/v1/admin/payment/wechat/status` 接口
- 后端进行脱敏处理后返回
- 前端 `PaymentConfigCard.vue` 组件

**覆盖需求:** FR2

---

#### Story 1.3: 管理端配置充值业务参数
**作为** 系统管理员
**我希望** 在管理后台调整充值业务参数（金额选项、限额等）
**以便** 根据运营需求灵活调整充值配置

**验收标准:**
- [ ] 管理端可配置最小充值金额（默认1元）
- [ ] 管理端可配置最大充值金额（默认1000元）
- [ ] 管理端可配置默认充值金额选项（如：[10, 50, 100, 200, 500]）
- [ ] 管理端可配置订单过期时间（分钟，默认120）
- [ ] 输入验证：最小金额 ≤ 最大金额
- [ ] 输入验证：金额选项在允许范围内
- [ ] 保存时显示成功/失败提示

**技术要点:**
- 新增 PUT `/api/v1/admin/settings/recharge` 接口
- 配置存储到 `settings` 表（key: `recharge.min_amount` 等）
- 前端 `RechargeSettingsForm.vue` 组件

**覆盖需求:** FR3

---

#### Story 1.4: 配置实时生效机制
**作为** 系统管理员
**我希望** 修改充值配置后立即生效，无需重启服务
**以便** 快速响应运营需求变化

**验收标准:**
- [ ] 配置保存到数据库 `settings` 表
- [ ] 配置变更后无需重启服务即可生效
- [ ] 使用内存缓存 + 定期刷新机制（1分钟）
- [ ] 或使用配置变更通知机制

**技术要点:**
- 实现 `SettingsService` 配置服务
- 使用 sync.RWMutex 保护配置读写
- 定时从数据库同步配置到内存

**覆盖需求:** FR4

---

#### Story 1.5: 配置优先级处理
**作为** 系统开发者
**我希望** 数据库配置优先于文件配置
**以便** 支持运行时动态调整而保留默认值回退

**验收标准:**
- [ ] 系统优先读取数据库中的充值业务配置
- [ ] 数据库中不存在该配置项时，使用 `config.yaml` 的默认值
- [ ] 配置优先级：数据库 > config.yaml > 代码默认值
- [ ] 配置读取逻辑封装在统一的配置服务中

**技术要点:**
- 实现 `GetRechargeConfig()` 方法
- 分层读取：DB → File → Default

**覆盖需求:** FR5

---

#### Story 1.6: 充值菜单显示控制
**作为** 普通用户
**我希望** 只有在充值功能启用时才看到充值入口
**以便** 避免看到无法使用的功能

**验收标准:**
- [ ] 前端根据 `wechat_pay.enabled` 控制菜单显隐（简化为单一开关）
- [ ] GET `/api/v1/recharge/config` 接口返回 `enabled` 字段
- [ ] 启用时侧边栏显示「余额充值」菜单项
- [ ] 禁用时隐藏菜单项，直接访问路由跳转到首页

**技术要点:**
- 前端在路由守卫 `router/index.ts` 中检查配置
- 使用 Pinia store (`stores/recharge.ts`) 缓存配置状态
- 菜单项在 `components/layout/Sidebar.vue` 中条件渲染

**覆盖需求:** FR30

---

### Epic 2: 充值订单创建与支付

#### Story 2.1: 充值页面与余额展示
**作为** 普通用户
**我希望** 进入充值页面时看到当前账户余额
**以便** 了解当前余额并决定充值金额

**验收标准:**
- [ ] 充值页面顶部显示当前账户余额（格式：¥XX.XX）
- [ ] 余额从用户信息接口获取
- [ ] 余额显示实时刷新（进入页面时重新获取）
- [ ] 页面加载时显示loading状态

**技术要点:**
- 复用 `/api/v1/user/info` 接口获取余额（用户表已有 balance 字段）
- 前端页面路径：`src/views/user/recharge/RechargeView.vue`

**覆盖需求:** FR6

---

#### Story 2.2: 充值金额选择器
**作为** 普通用户
**我希望** 通过快捷按钮或自定义输入选择充值金额
**以便** 方便快速地选择常用金额或精确输入

**验收标准:**
- [ ] 显示快捷金额按钮（从配置获取，如：10、50、100、200、500元）
- [ ] 点击快捷按钮选中对应金额，按钮高亮显示
- [ ] 支持自定义金额输入框
- [ ] 输入自定义金额时取消快捷按钮选中状态
- [ ] 金额输入只允许数字和小数点，最多2位小数
- [ ] 显示充值金额范围提示（如：最小1元，最大1000元）

**技术要点:**
- 前端组件路径：`src/components/user/recharge/AmountSelector.vue`
- 使用 v-model 双向绑定金额
- 输入校验使用正则表达式

**覆盖需求:** FR7

---

#### Story 2.3: 充值金额范围验证
**作为** 系统
**我希望** 验证用户输入的充值金额在允许范围内
**以便** 防止无效或异常金额的订单

**验收标准:**
- [ ] 前端验证：金额 ≥ min_amount 且 ≤ max_amount
- [ ] 后端验证：金额范围校验
- [ ] 金额不在范围内时显示错误提示
- [ ] 提交按钮在金额无效时禁用
- [ ] 错误提示明确说明允许范围

**技术要点:**
- 前端 computed 属性计算金额有效性
- 后端在创建订单时校验

**覆盖需求:** FR8

---

#### Story 2.4: 支付方式选择与订单发起
**作为** 普通用户
**我希望** 选择支付方式并发起充值订单
**以便** 开始支付流程

**验收标准:**
- [ ] 显示支付方式选择器（当前仅支持微信支付）
- [ ] 微信支付图标和名称显示
- [ ] 点击「立即充值」按钮发起订单
- [ ] 按钮点击后显示loading状态，防止重复提交
- [ ] 订单创建成功后跳转到支付页面
- [ ] 订单创建失败显示错误提示

**技术要点:**
- 前端组件路径：`src/components/user/recharge/PaymentMethodSelector.vue`
- 调用 POST `/api/v1/recharge/orders` 接口
- API客户端：`src/api/recharge.ts`

**覆盖需求:** FR9

---

#### Story 2.5: 充值订单创建
**作为** 系统
**我希望** 创建充值订单并生成唯一订单号
**以便** 追踪支付流程和后续对账

**验收标准:**
- [ ] 订单号格式：RECH + 年月日时分秒 + 10位随机字符串（如：RECH20260124150000AbCd1234Ef）
- [ ] 订单号全局唯一（数据库唯一索引）
- [ ] 订单初始状态为 `pending`
- [ ] 记录：user_id, amount, payment_method, payment_channel
- [ ] 设置订单过期时间（created_at + expire_minutes）
- [ ] 订单创建时间精确到毫秒

**技术要点:**
- 使用 `recharge_orders` 表存储
- 订单号生成使用时间戳+随机串
- Ent schema 定义

**覆盖需求:** FR10

---

#### Story 2.6: 微信支付订单创建
**作为** 系统
**我希望** 调用微信支付API创建支付订单
**以便** 获取支付参数供用户完成支付

**验收标准:**
- [ ] 调用微信支付下单API（Native或JSAPI）
- [ ] 传递参数：商户订单号、金额（分）、商品描述、notify_url
- [ ] 保存返回的 prepay_id
- [ ] API调用超时设置为30秒
- [ ] API调用失败时记录详细错误日志
- [ ] 返回给前端：订单号、支付参数

**技术要点:**
- 使用微信支付Go SDK
- 金额转换：元 → 分（乘100）
- 实现 `WeChatPayService.CreateOrder()`

**覆盖需求:** FR11

---

#### Story 2.7: Native支付二维码生成
**作为** 普通用户（PC端）
**我希望** 看到支付二维码进行扫码支付
**以便** 在PC端使用微信扫码完成支付

**验收标准:**
- [ ] Native支付返回 code_url
- [ ] 前端根据 code_url 生成二维码图片
- [ ] 二维码尺寸适中（200x200像素）
- [ ] 二维码下方显示「请使用微信扫码支付」提示
- [ ] 二维码生成时间 < 1秒

**技术要点:**
- 使用 qrcode.js 或 vue-qrcode 组件生成二维码
- 前端组件路径：`src/components/user/recharge/QRCodeDisplay.vue`

**覆盖需求:** FR12

---

#### Story 2.8: JSAPI支付调起
**作为** 普通用户（微信内）
**我希望** 在微信内直接调起支付
**以便** 在微信浏览器中便捷支付

**验收标准:**
- [ ] JSAPI支付返回前端调起参数（appId, timeStamp, nonceStr, package, signType, paySign）
- [ ] 前端调用 WeixinJSBridge 或微信JS-SDK调起支付
- [ ] 支付成功后跳转到成功页面
- [ ] 支付失败或取消后显示相应提示
- [ ] 非微信环境下隐藏JSAPI支付选项

**技术要点:**
- 后端签名参数
- 前端检测微信环境 `navigator.userAgent`
- 调用 `wx.chooseWXPay()`

**覆盖需求:** FR13

---

### Epic 3: 支付回调与余额到账

#### Story 3.1: 接收微信支付回调
**作为** 系统
**我希望** 接收微信支付平台的异步回调通知
**以便** 获知用户支付结果

**验收标准:**
- [ ] 提供 POST `/api/v1/webhook/wechat/payment` 回调接口
- [ ] 回调接口无需JWT认证
- [ ] 记录所有回调请求到 `payment_callbacks` 表
- [ ] 记录内容：请求头、请求体、接收时间
- [ ] 响应格式符合微信支付规范

**技术要点:**
- 回调路由注册在公开路由组
- 使用中间件记录原始请求

**覆盖需求:** FR14

---

#### Story 3.2: 回调签名验证与数据解密
**作为** 系统
**我希望** 验证回调签名并解密回调数据
**以便** 确保回调来自微信支付平台且数据未被篡改

**验收标准:**
- [ ] 使用微信支付平台证书验证签名
- [ ] 验证请求头中的 `Wechatpay-Timestamp`, `Wechatpay-Nonce`, `Wechatpay-Signature`
- [ ] 拒绝超过5分钟的请求（防重放攻击）
- [ ] 使用 APIv3 密钥解密回调数据（AEAD_AES_256_GCM）
- [ ] 签名验证失败时返回 FAIL 并记录日志
- [ ] 更新 `payment_callbacks` 表的 `signature_valid` 字段

**技术要点:**
- 使用微信支付Go SDK的验签方法
- 时间戳检查：当前时间 - 请求时间 ≤ 300秒

**覆盖需求:** FR15, NFR2, NFR6

---

#### Story 3.3: 订单状态更新与余额到账
**作为** 系统
**我希望** 回调验证通过后更新订单状态并增加用户余额
**以便** 完成充值流程

**验收标准:**
- [ ] 使用Redis分布式锁（key: `recharge:callback:{order_no}`，过期时间30秒）
- [ ] 检查订单状态是否为 `pending`，非pending直接返回SUCCESS
- [ ] 验证回调金额与订单金额一致
- [ ] 在同一数据库事务中：
  - 更新订单状态为 `paid`
  - 记录 `transaction_id` 和 `paid_at`
  - 使用行锁（SELECT FOR UPDATE）增加用户余额
  - 插入余额变动日志
- [ ] 事务成功后返回 SUCCESS
- [ ] 事务失败时回滚并返回 FAIL

**技术要点:**
- Redis分布式锁使用 SETNX + 过期时间
- 数据库事务使用 Ent 的 `Tx`
- 用户表已有 `balance` 字段（decimal(20,8)），无需新增
- 行锁：`SELECT balance FROM users WHERE id = ? FOR UPDATE`
- 余额更新：`UPDATE users SET balance = balance + ? WHERE id = ?`

**覆盖需求:** FR16, FR17, NFR7, NFR8, NFR9, NFR16

---

#### Story 3.4: 余额变动日志记录
**作为** 系统
**我希望** 记录每笔余额变动的详细日志
**以便** 支持审计追溯和问题排查

**验收标准:**
- [ ] 插入 `balance_logs` 表记录
- [ ] 记录字段：user_id, change_type（recharge）, amount, balance_before, balance_after
- [ ] 记录 related_order_no 关联订单号
- [ ] 记录 operator_type（system）和 description
- [ ] 日志表只允许插入，不允许修改删除（应用层控制）

**技术要点:**
- `balance_logs` Ent schema
- 在事务中插入日志

**覆盖需求:** FR18, NFR23, NFR24

---

#### Story 3.5: 充值成功通知
**作为** 普通用户
**我希望** 充值成功后收到站内信通知
**以便** 及时了解充值结果

**验收标准:**
- [ ] 支付成功后异步发送站内信
- [ ] 通知内容：充值金额、订单号、到账时间、当前余额
- [ ] 使用goroutine异步发送，不阻塞回调响应
- [ ] 发送失败时记录错误日志但不影响主流程

**技术要点:**
- 使用 channel 或 goroutine 异步发送
- 调用现有的通知服务

**覆盖需求:** FR19

---

### Epic 4: 订单状态管理与前端体验

#### Story 4.1: 查询单个订单详情
**作为** 普通用户
**我希望** 查询某个充值订单的详细状态
**以便** 了解订单的支付进度

**验收标准:**
- [ ] GET `/api/v1/recharge/orders/:order_no` 接口
- [ ] 返回字段：order_no, amount, status, payment_method, created_at, paid_at, expired_at
- [ ] 只能查询自己的订单
- [ ] 订单不存在时返回404

**技术要点:**
- 查询时校验 user_id 匹配
- 使用 Ent 的 `Where` 条件

**覆盖需求:** FR20

---

#### Story 4.2: 充值记录列表
**作为** 普通用户
**我希望** 查看我的充值记录列表
**以便** 了解历史充值情况

**验收标准:**
- [ ] GET `/api/v1/recharge/orders` 接口
- [ ] 分页展示，每页10条，按创建时间倒序
- [ ] 支持筛选条件：状态（可选）、时间范围（可选）
- [ ] 返回字段：order_no, amount, status, created_at, paid_at
- [ ] 返回分页信息：total, page, page_size

**技术要点:**
- 分页使用 Offset + Limit
- 前端页面路径：`src/views/user/recharge/RechargeRecordsView.vue`

**覆盖需求:** FR21

---

#### Story 4.3: 取消未支付订单
**作为** 普通用户
**我希望** 取消未支付的充值订单
**以便** 放弃当前订单重新充值

**验收标准:**
- [ ] POST `/api/v1/recharge/orders/:order_no/cancel` 接口
- [ ] 只能取消状态为 `pending` 的订单
- [ ] 取消后状态变为 `failed`
- [ ] 记录取消原因：用户主动取消
- [ ] 已支付/已过期/已取消的订单不可再取消

**技术要点:**
- 乐观锁或条件更新防止并发问题
- `UPDATE ... WHERE status = 'pending'`

**覆盖需求:** FR22

---

#### Story 4.4: 订单过期自动处理
**作为** 系统
**我希望** 自动将超时未支付的订单标记为过期
**以便** 清理无效订单

**验收标准:**
- [ ] 定时任务每分钟执行一次
- [ ] 扫描 `status = pending` 且 `expired_at < now()` 的订单
- [ ] 批量更新状态为 `expired`
- [ ] 每次最多处理100条
- [ ] 记录过期订单数量日志

**技术要点:**
- 使用 cron 或 ticker 定时执行
- 批量更新使用 `UPDATE ... WHERE ... LIMIT`

**覆盖需求:** FR23, FR24

---

#### Story 4.5: 微信关闭订单API调用
**作为** 系统
**我希望** 订单过期时调用微信关闭订单API
**以便** 防止用户在过期后仍能支付成功

**验收标准:**
- [ ] 订单标记为expired后调用微信"关闭订单"API
- [ ] API调用失败时记录错误日志但不阻塞过期处理
- [ ] 使用goroutine异步调用，不阻塞主流程
- [ ] 记录关闭结果到订单备注字段

**技术要点:**
- 调用微信支付SDK的关单方法
- 异步处理避免超时

**覆盖需求:** FR25

---

#### Story 4.6: 前端订单状态轮询
**作为** 前端应用
**我希望** 定期轮询订单状态
**以便** 在用户支付成功后及时跳转

**验收标准:**
- [ ] 支付中页面每3秒查询一次订单状态
- [ ] 最多轮询40次（共2分钟）
- [ ] 状态变为 `paid` 时跳转到成功页面
- [ ] 状态变为 `failed` 或 `expired` 时跳转到失败页面
- [ ] 轮询期间页面显示loading指示器
- [ ] 页面离开时停止轮询

**技术要点:**
- 使用 setInterval + clearInterval
- 组件 onUnmounted 清理定时器

**覆盖需求:** FR31

---

#### Story 4.7: 支付中页面倒计时
**作为** 普通用户
**我希望** 看到订单过期倒计时
**以便** 了解剩余支付时间

**验收标准:**
- [ ] 显示格式：XX分XX秒
- [ ] 每秒更新一次
- [ ] 倒计时归零时跳转到失败页面
- [ ] 倒计时与后端过期时间同步

**技术要点:**
- 前端组件路径：`src/components/user/recharge/OrderCountdown.vue`
- 根据 expired_at 计算剩余时间

**覆盖需求:** FR32

---

#### Story 4.8: 充值成功页面
**作为** 普通用户
**我希望** 支付成功后看到确认页面
**以便** 确认充值结果

**验收标准:**
- [ ] 显示成功图标和「充值成功」标题
- [ ] 显示充值金额（大字体）
- [ ] 显示订单号
- [ ] 显示当前账户余额
- [ ] 提供「返回首页」和「继续充值」按钮

**技术要点:**
- 前端页面路径：`src/views/user/recharge/RechargeSuccessView.vue`
- 从路由参数或订单详情获取数据

**覆盖需求:** FR33

---

#### Story 4.9: 充值失败页面
**作为** 普通用户
**我希望** 支付失败或过期后看到失败页面
**以便** 了解失败原因并可以重试

**验收标准:**
- [ ] 显示失败图标和「充值失败」标题
- [ ] 显示失败原因（支付失败/订单过期/用户取消）
- [ ] 提供「重新充值」按钮
- [ ] 提供「查看充值记录」链接

**技术要点:**
- 前端页面路径：`src/views/user/recharge/RechargeFailedView.vue`
- 根据订单状态显示不同失败原因

**覆盖需求:** FR34

---

### Epic 5: 支付状态补偿机制

#### Story 5.1: 手动同步订单状态按钮
**作为** 普通用户
**我希望** 点击按钮主动查询订单的支付状态
**以便** 在回调延迟时确认支付结果

**验收标准:**
- [ ] 支付中页面显示「手动查询订单状态」按钮
- [ ] 按钮点击后调用同步接口
- [ ] 按钮有冷却时间（5秒内不可重复点击）
- [ ] 同步中显示loading状态
- [ ] 同步结果显示提示（已支付/支付中/支付失败）

**技术要点:**
- 前端按钮状态管理
- 调用 POST `/api/v1/recharge/orders/:order_no/sync`

**覆盖需求:** FR26

---

#### Story 5.2: 查询微信支付订单状态
**作为** 系统
**我希望** 调用微信支付查询接口获取真实支付状态
**以便** 与本地订单状态进行对比

**验收标准:**
- [ ] POST `/api/v1/recharge/orders/:order_no/sync` 接口
- [ ] 调用微信支付查询订单API
- [ ] 返回微信侧的订单状态
- [ ] API调用失败时返回错误信息
- [ ] 记录查询结果日志

**技术要点:**
- 使用微信支付SDK的查询订单方法
- 处理各种状态：SUCCESS, REFUND, NOTPAY, CLOSED, PAYERROR

**覆盖需求:** FR27

---

#### Story 5.3: 补偿到账逻辑
**作为** 系统
**我希望** 发现微信已支付但本地未到账时自动触发到账
**以便** 保证用户权益

**验收标准:**
- [ ] 查询结果为 SUCCESS 但本地状态为 pending 时触发到账
- [ ] 复用回调处理的到账逻辑（分布式锁+事务）
- [ ] 到账成功后更新订单状态和余额
- [ ] 到账成功后发送通知
- [ ] 记录补偿到账日志

**技术要点:**
- 复用 `processPaymentSuccess()` 方法
- 增加补偿标记区分正常回调和补偿

**覆盖需求:** FR28

---

#### Story 5.4: 定时订单状态补偿任务
**作为** 系统
**我希望** 定时扫描可能遗漏的订单并主动查询
**以便** 自动发现和补偿回调丢失的情况

**验收标准:**
- [ ] 定时任务每5分钟执行一次
- [ ] 扫描 `status = pending` 且 `created_at < now() - 5分钟` 的订单
- [ ] 对每个订单调用微信查询接口
- [ ] 如果微信返回已支付则触发补偿到账
- [ ] 每次最多处理50条
- [ ] 记录补偿任务执行日志

**技术要点:**
- 使用 cron 定时执行
- 限制并发数避免请求过多

**覆盖需求:** FR29

---

### Epic 6: 风控与安全防护

#### Story 6.1: 用户分钟级限流
**作为** 系统
**我希望** 限制同一用户1分钟内最多创建3个订单
**以便** 防止恶意刷单

**验收标准:**
- [ ] 创建订单接口检查用户分钟级订单数
- [ ] 超过限制返回 429 状态码和提示信息
- [ ] 使用 Redis 滑动窗口或令牌桶实现
- [ ] 限流配置可调整

**技术要点:**
- Redis key: `ratelimit:recharge:user:{user_id}:minute`
- 使用 INCR + EXPIRE 或 sorted set

**覆盖需求:** FR35

---

#### Story 6.2: 用户日级限流
**作为** 系统
**我希望** 限制同一用户每天最多创建20个订单
**以便** 防止过度频繁充值

**验收标准:**
- [ ] 创建订单接口检查用户当日订单数
- [ ] 超过限制返回 429 状态码和提示信息
- [ ] 日级计数器每日零点重置
- [ ] 限流配置可调整

**技术要点:**
- Redis key: `ratelimit:recharge:user:{user_id}:day:{date}`
- 设置过期时间为次日凌晨

**覆盖需求:** FR36

---

#### Story 6.3: IP级限流与验证码
**作为** 系统
**我希望** 同一IP短时间内创建大量订单时触发验证码验证
**以便** 防止机器人批量攻击

**验收标准:**
- [ ] 监控同一IP的订单创建频率
- [ ] 超过阈值（如：10分钟内20个订单）触发验证码
- [ ] 前端显示验证码输入框
- [ ] 验证通过后允许继续创建订单
- [ ] 验证码有效期5分钟

**技术要点:**
- Redis 记录 IP 订单创建计数
- 集成验证码服务（可使用现有组件）
- 接口增加验证码参数

**覆盖需求:** FR37

---

### Epic 7: 退款管理（预留）

#### Story 7.1: 管理端退款入口
**作为** 系统管理员
**我希望** 在管理后台对已支付订单触发退款操作
**以便** 处理用户退款申请

**验收标准:**
- [ ] 管理端订单详情页显示「退款」按钮
- [ ] 仅 `paid` 状态订单可退款
- [ ] 退款前需要输入退款原因
- [ ] 退款操作需要二次确认
- [ ] 退款后按钮变为已退款状态

**技术要点:**
- 管理端页面路径：`src/views/admin/recharge/OrderDetailView.vue` 增加退款功能
- 调用 POST `/api/v1/admin/recharge/orders/:order_no/refund`

**覆盖需求:** FR38

---

#### Story 7.2: 调用微信退款API
**作为** 系统
**我希望** 调用微信退款API处理退款
**以便** 将款项退回用户微信账户

**验收标准:**
- [ ] 调用微信支付退款API
- [ ] 传递参数：原订单号、退款金额、退款原因
- [ ] 处理退款结果（成功/处理中/失败）
- [ ] 退款失败时返回错误信息
- [ ] 记录退款请求和响应日志

**技术要点:**
- 使用微信支付SDK的退款方法
- 处理异步退款结果通知

**覆盖需求:** FR39

---

#### Story 7.3: 扣减用户余额
**作为** 系统
**我希望** 退款成功后扣减用户账户余额
**以便** 保持余额与实际到账一致

**验收标准:**
- [ ] 退款成功后在事务中扣减用户余额
- [ ] 扣减金额等于退款金额
- [ ] 余额不足时（已消费）记录警告但继续退款
- [ ] 插入余额变动日志（change_type: refund）

**技术要点:**
- 用户表已有 `balance` 字段（decimal(20,8)），无需新增
- 事务中处理余额扣减：`UPDATE users SET balance = balance - ? WHERE id = ?`
- 余额可能为负的边缘情况处理（用户已消费部分余额）

**覆盖需求:** FR39

---

#### Story 7.4: 退款状态更新与日志
**作为** 系统
**我希望** 更新订单状态为已退款并记录退款日志
**以便** 完整追踪退款流程

**验收标准:**
- [ ] 更新订单状态为 `refunded`
- [ ] 记录退款时间、退款金额、退款原因
- [ ] 记录操作人（admin_id）
- [ ] 插入退款日志到 `balance_logs` 表
- [ ] 日志包含退款前后余额

**技术要点:**
- 订单表增加 refunded_at, refund_reason 字段
- balance_logs 记录 operator_id 和 operator_type

**覆盖需求:** FR40

---

## Story Summary

| Epic | Stories | 覆盖需求数 |
|------|---------|-----------|
| Epic 1: 配置管理 | 6 | 6 |
| Epic 2: 订单创建 | 8 | 8 |
| Epic 3: 支付回调 | 5 | 6 |
| Epic 4: 订单管理 | 9 | 10 |
| Epic 5: 补偿机制 | 4 | 4 |
| Epic 6: 风控安全 | 3 | 3 |
| Epic 7: 退款管理 | 4 | 3 |
| **总计** | **39** | **40** |

---

## Implementation Priority

> **修订说明 (2026-01-25)**: 原 Phase 1 体量过大（约17个故事），且存在配置依赖倒置问题。
> 现拆分为更小的纵向切片，每个 Sprint 可独立交付价值。

### Sprint 1: 配置基础 + 下单流程
**目标**: 用户可进入充值页面、选择金额、创建订单

1. Story 1.1 - 加载微信支付敏感配置
2. Story 1.6 - 充值菜单显示控制（需要 `enabled` 配置）
3. Story 2.1 - 充值页面余额展示
4. Story 2.2 - 充值金额选择器（使用硬编码默认配置）
5. Story 2.3 - 充值金额范围验证
6. Story 2.4 - 支付方式选择与订单发起
7. Story 2.5 - 充值订单创建

**配置依赖解决方案**: 实现 `GetRechargeConfig()` 返回硬编码默认值：
```go
const (
    DefaultMinAmount     = 1.0
    DefaultMaxAmount     = 1000.0
    DefaultExpireMinutes = 120
)
var DefaultAmountOptions = []float64{10, 50, 100, 200, 500}
```

### Sprint 2: 支付集成 + 结果页面
**目标**: 完整支付流程闭环（PC端扫码支付）

8. Story 2.6 - 微信支付订单创建
9. Story 2.7 - Native支付二维码生成
10. Story 3.1 - 接收微信支付回调
11. Story 3.2 - 回调签名验证与解密
12. Story 3.3 - 订单状态更新与余额到账
13. Story 3.4 - 余额变动日志
14. Story 4.1 - 查询单个订单详情
15. Story 4.6 - 前端订单状态轮询
16. Story 4.7 - 支付中页面倒计时
17. Story 4.8 - 充值成功页面
18. Story 4.9 - 充值失败页面

**可选**: 如果主要用户在微信内访问，增加 Story 2.8 (JSAPI支付)

### Sprint 3: 订单管理 + 基础防护
**目标**: 防止订单悬挂和基础滥用

19. Story 4.2 - 充值记录列表
20. Story 4.3 - 取消未支付订单
21. Story 4.4 - 订单过期自动处理
22. Story 4.5 - 微信关单API调用
23. Story 6.1 - 用户分钟级限流（基础防护）

### Sprint 4: 补偿机制 + 完整限流
**目标**: 处理边缘情况，完善风控

24. Story 5.1 - 手动同步订单状态按钮
25. Story 5.2 - 查询微信订单状态
26. Story 5.3 - 补偿到账逻辑
27. Story 5.4 - 定时任务订单补偿
28. Story 6.2 - 用户日级限流
29. Story 6.3 - IP限流与验证码

### Sprint 5: 管理端配置（可选）
**目标**: 运营可动态调整配置

30. Story 1.2 - 管理端只读显示支付状态
31. Story 1.3 - 管理端配置充值业务参数
32. Story 1.4 - 配置实时生效机制
33. Story 1.5 - 配置优先级处理
34. Story 3.5 - 充值成功通知

### Sprint 6: 退款管理（预留）
**目标**: 支持退款场景

35. Story 7.1 - 管理端退款入口
36. Story 7.2 - 调用微信退款API
37. Story 7.3 - 扣减用户余额
38. Story 7.4 - 退款状态更新与日志

---

## 技术调整说明（2026-01-24）

基于项目实际代码结构审查，对用户故事做了以下调整：

### 1. 用户表 balance 字段已存在
- **影响**: Story 3.3, 7.3
- **说明**: `backend/ent/schema/user.go` 已定义 `balance` 字段（decimal(20,8)），无需新增
- **调整**: 技术要点中明确"用户表已有 balance 字段，无需新增"

### 2. 数据库表从4张减少为3张
- **移除**: `payment_configs` 表
- **原因**:
  - 敏感配置存储在 `config.yaml`（Story 1.1）
  - 非敏感业务配置存储在现有 `settings` 表（key-value 模式）
- **保留**: `recharge_orders`, `balance_logs`, `payment_callbacks`

### 3. 配置结构补充
- **新增**: `WeChatPayConfig` 结构体定义添加到 Story 1.1 技术要点
- **位置**: `backend/internal/config/config.go`

### 4. 充值开关简化
- **调整**: Story 1.6 从双开关简化为单一 `wechat_pay.enabled` 开关
- **原因**: 减少配置复杂度，微信支付启用即代表充值功能启用

### 5. 前端路径对齐项目结构
- **页面路径**: `src/views/user/recharge/*.vue`
- **组件路径**: `src/components/user/recharge/*.vue`
- **Store路径**: `src/stores/recharge.ts`
- **API客户端**: `src/api/recharge.ts`
- **管理端路径**: `src/views/admin/recharge/*.vue`
